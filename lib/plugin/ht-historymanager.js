!function(K,q,d){"use strict";var T="ht",O=K[T],Y=O.Default,w=Y.def,h=Y.getInternal();O.HistoryManager=function(s){this._histories=[],this.setDataModel(s)},w(O.HistoryManager,q,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var O=this;O._betweenTransaction++,1===O._betweenTransaction&&(O._transactionHistories={})}},endTransaction:function(){if(!this._disabled){var N=this,L=N._histories;if(N._betweenTransaction>0&&N._betweenTransaction--,0===N._betweenTransaction){if(N._transactionHistories){var R=[];for(var Z in N._transactionHistories)R.push(N._transactionHistories[Z]);R.length&&(L=L.slice(0,N._historyIndex+1),L.push(R),L.length>N._maxHistoryCount&&(L=L.slice(L.length-N._maxHistoryCount)),N.setHistories(L),N.setHistoryIndex(L.length-1,!0))}delete N._transactionHistories}}},setDataModel:function(E){var o=this,z=o._dataModel;z!==E&&(z&&(delete z._historyManager,z.ump(o.handleDataModelPropertyChange,o),z.umm(o.$5p,o),z.umd(o.$6p,o),z.removeHierarchyChangeListener(o.handleHierarchyChange,o),z.removeIndexChangeListener(o.handleIndexChange,o)),o._dataModel=E,E&&(E._historyManager=o,E.mp(o.handleDataModelPropertyChange,o),E.mm(o.$5p,o),E.md(o.$6p,o),E.addHierarchyChangeListener(o.handleHierarchyChange,o),E.addIndexChangeListener(o.handleIndexChange,o)),o.fp("dataModel",z,E),o.clear())},setHistoryIndex:function(b,Y){var F=this,s=F._historyIndex,T=F._histories.length;if(-1>b?b=-1:b>=T&&(b=T-1),s!==b){if(!Y){var l=b-s;l>0?F.$2p(l):0>l&&F.$1p(-l)}F._historyIndex=b,F.fp("historyIndex",s,b),F.dataModel&&F.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(U){var b=this,B=b._histories,e=b._maxHistoryCount;(!U||0>=U)&&(U=10),e!==U&&(b._maxHistoryCount=U,b.fp("maxHistoryCount",e,U),B.length>U&&b.clear())},cloneValue:function(b){return O.Default.clone(b)},isPropertyUndoable:function(m){return m&&!this.ignoredPropertyMap[m]},isIndexUndoable:function(){return!1},isDataModelPropertyUndoable:function(d){return d&&!this.ignoreDataModelPropertyMap[d]},$5p:function(j){this.handleChange(j,j.kind)},$6p:function(y){this.handleChange(y,"property")},handleHierarchyChange:function(r){this.handleChange(r,"hierarchy")},handleIndexChange:function(U){this.handleChange(U,"index")},handleDataModelPropertyChange:function(K){this.handleChange(K,"dataModelProperty")},toChildrenInfo:function(B){var O={};return O.data=B,O.children=[],B.eachChild(function(P){O.children.push(this.toChildrenInfo(P))},this),O},restoreChildren:function(R){var F=R.data;R.children.forEach(function($){var D=$.data;D.getParent()!==F&&F.addChild(D),this._dataModel.contains(D)||this._dataModel.add(D),this.restoreChildren($)},this)},handleChange:function(N,P){var E=this;if(!(E._disabled||E._isUndoRedoing||Y.loadingRefGraph)){var K,o=(E._histories,N.data),A=N.property;if(!o||!(o._refGraph||o instanceof O.RefGraph)){if("property"===P)E.isPropertyUndoable(A,o)&&(K={kind:P,data:o,property:A,oldValue:E.cloneValue(N.oldValue,o,A),newValue:E.cloneValue(N.newValue,o,A),event:N});else if("hierarchy"===P||"index"===P&&E.isIndexUndoable(N))K={kind:P,data:o,oldIndex:N.oldIndex,newIndex:N.newIndex,event:N};else if("clear"===P)K={kind:P,json:N.json,event:N};else if("add"===P){if(K={kind:P,data:o,event:N,childrenInfo:this.toChildrenInfo(o),parent:o.getParent()},K.parent){var D=E._dataModel.getSiblings(o);K.siblingsIndex=D.indexOf(o)}o instanceof O.Node&&(K.host=o.getHost(),K.attaches=o.getAttaches()?o.getAttaches().toArray():d),o instanceof O.Edge&&(K.source=o.getSource(),K.target=o.getTarget())}else"remove"===P?K={kind:P,data:o,event:N}:"dataModelProperty"===P&&E.isDataModelPropertyUndoable(A,o)&&(K={kind:P,property:A,oldValue:E.cloneValue(N.oldValue,o,A),newValue:E.cloneValue(N.newValue,o,A),event:N});E.addHistory(K)}}},addHistory:function(f){var r=this;if(f)if(r._betweenTransaction){var g=(f.data?f.data._id:0)+"_"+f.kind+"_"+f.property;if("property"===f.kind||"dataModelProperty"===f.kind){var U=r._transactionHistories[g];U&&(f.oldValue=U.oldValue)}r._transactionHistories[g]=f}else{var i=r._histories;i=i.slice(0,r._historyIndex+1),i.push([f]),i.length>r._maxHistoryCount&&(i=i.slice(i.length-r._maxHistoryCount)),r.setHistories(i),r.setHistoryIndex(i.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(J){(!J||0>=J)&&(J=1),this.setHistoryIndex(this._historyIndex-J)},$1p:function(k){if(this.canUndo()){var o,x=this,b=x._dataModel,m=x._histories,y=x._historyIndex,a=0;for(x._isUndoRedoing=!0,Y.setIsolating(!0);k>0;){if(y>=0&&y<m.length){a++,o=m[y],y--;for(var A=o.length-1;A>=0;A--){var W=o[A],T=W.kind,s=W.data,D=W.property,n=W.event,j=this.cloneValue(W.oldValue,s,D);if(W.undo)W.undo();else if("add"===T)b.remove(s,{keepChildren:!0});else if("remove"===T)b.contains(s)||b.add(s,n.rootsIndex,n.datasIndex);else if("clear"===T)b.deserialize(Y.clone(W.json));else if("property"===T)if("parent"===D)j?j.addChild(s,n.oldIndex):(s.setParent(j),n.oldIndex>=0&&b.moveTo(s,n.oldIndex));else{var f=null;0===D.indexOf("a:")?(f="attr",D=D.replace("a:","")):0===D.indexOf("s:")?(f="style",D=D.replace("s:","")):0===D.indexOf("f:")&&(f="field",D=D.replace("f:","")),h.setPropertyValue(s,f,D,j)}else if("dataModelProperty"===T){var f=null;0===D.indexOf("a:")?(f="attr",D=D.replace("a:","")):0===D.indexOf("s:")?(f="style",D=D.replace("s:","")):0===D.indexOf("f:")&&(f="field",D=D.replace("f:","")),h.setPropertyValue(b,f,D,j)}else"hierarchy"===T?b.moveTo(s,W.oldIndex):"index"===T?b.moveToIndex(s,W.oldIndex):"selection"===T&&b.sm().ss(W.oldValue)}}k--}Y.setIsolating(!1),delete x._isUndoRedoing,x.afterUndo(a)}},afterUndo:function(){},redo:function(e){(!e||0>=e)&&(e=1),this.setHistoryIndex(this._historyIndex+e)},$2p:function(z){if(this.canRedo()){var G,C=this,U=C._dataModel,I=C._histories,T=C._historyIndex,Z=0;for(C._isUndoRedoing=!0,Y.setIsolating(!0);z>0;){if(T>=-1&&T<I.length-1){Z++,T++,G=I[T];for(var J=0;J<G.length;J++){var W=G[J],j=W.kind,P=W.data,v=W.property,K=W.event,D=this.cloneValue(W.newValue,P,v);if(W.redo)W.redo();else if("add"===j)W.parent&&!P.getParent()&&W.parent.addChild(P,W.siblingsIndex),U.contains(P)||U.add(P,K.rootsIndex,K.datasIndex),this.restoreChildren(W.childrenInfo),P instanceof O.Node&&(P.setHost(W.host),W.attaches&&W.attaches.forEach(function(u){u.setHost(P)})),P instanceof O.Edge&&(P.setSource(W.source),P.setTarget(W.target));else if("remove"===j)U.remove(P);else if("clear"===j)U.clear();else if("property"===j)if("parent"===v)D?D.addChild(P,K.newIndex):(P.setParent(D),K.newIndex>=0&&U.moveTo(P,K.newIndex));else{var p=null;0===v.indexOf("a:")?(p="attr",v=v.replace("a:","")):0===v.indexOf("s:")?(p="style",v=v.replace("s:","")):0===v.indexOf("f:")&&(p="field",v=v.replace("f:","")),h.setPropertyValue(P,p,v,D)}else if("dataModelProperty"===j){var p=null;0===v.indexOf("a:")?(p="attr",v=v.replace("a:","")):0===v.indexOf("s:")?(p="style",v=v.replace("s:","")):0===v.indexOf("f:")&&(p="field",v=v.replace("f:","")),h.setPropertyValue(U,p,v,D)}else"hierarchy"===j?U.moveTo(P,W.newIndex):"index"===j?U.moveToIndex(P,W.newIndex):"selection"===j&&U.sm().ss(W.newValue)}}z--}Y.setIsolating(!1),delete C._isUndoRedoing,this.afterRedo(Z)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);